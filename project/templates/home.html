<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sa√∫de IA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <header>
    <div class="logo">
      <div class="icon"></div>
      <h1>IA Sa√∫de</h1>
    </div>
    <p>Avalia√ß√£o r√°pida do seu estado e sugest√µes de atendimento</p>
    <div class="menu">
        <a href="{{ url_for('perfil') }}"><button>Perfil</button></a>
        <a href="{{ url_for('agendamento') }}"><button>Agendamento</button></a>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="user-card">
        <img src="https://via.placeholder.com/80" alt="avatar" />
        <h2>Voc√™</h2>
        <p>‚Äî</p>
      </div>

      <section class="info">
        <h3>Sintomas importantes</h3>
        <ul>
          <li>Febre alta (> 38.5¬∞C)</li>
          <li>Dificuldade para respirar</li>
          <li>Dor no peito intensa</li>
          <li>Sangramento incontrol√°vel</li>
        </ul>
      </section>

      <section class="classification">
        <h3>Classifica√ß√£o</h3>
        <ul>
          <li><span class="dot green"></span> Verde ‚Äî Observa√ß√£o / autocuidado</li>
          <li><span class="dot yellow"></span> Amarelo ‚Äî Consultar m√©dico em breve</li>
          <li><span class="dot red"></span> Vermelho ‚Äî Emerg√™ncia imediata</li>
        </ul>
      </section>
    </aside>

    <section class="chat relative max-w-[750px] mx-auto w-full" id="chat">

    <div class="chat-header">
        <h3>Assistente IA de Sa√∫de</h3>
        <div class="status"><span class="dot green"></span> Estado: ‚Äî</div>
    </div>

    <div class="pb-24 chat-container" id="chat-container">
        <div class="chat-messages" id="chat-messages">
            <div class="message ia">
                Ol√°! Eu sou o Assistente IA do hospital. Posso te ajudar a agendar consultas, fornecer informa√ß√µes sobre servi√ßos m√©dicos ou tirar d√∫vidas gerais de sa√∫de. Como posso te ajudar hoje?
            </div>
        </div>
    </div>

    <div id="chat-bar"
        class="chat-bar fixed inset-x-0 bottom-0 w-full z-50 bg-gray-200 border-t border-gray-400 p-3 flex items-center gap-2">
        <input id="user-input" type="text" placeholder="Digite sua mensagem..."
            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="send-btn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
            Enviar
        </button>
    </div>

    </section>

    <aside class="rightbar">
      <section class="help">
        <h3>Ajuda r√°pida</h3>
        <button class="emergency" id="emergency-btn">Estou em emerg√™ncia</button>
        <button class="find" id="find-btn">Encontrar m√©dico pr√≥ximo</button>

        <div id="emergency-info"></div>
        <ul id="medicos-list"></ul>
      </section>

      <section class="history">
        <h3>Hist√≥rico (local)</h3>
        <ul id="history-list"></ul>
      </section>
    </aside>
  </main>

  <script>
    const sendBtn = document.getElementById("send-btn");
    const userInput = document.getElementById("user-input");
    const chatMessages = document.getElementById("chat-messages");
    const historyList = document.getElementById("history-list");

    const emergencyBtn = document.getElementById("emergency-btn");
    const findBtn = document.getElementById("find-btn");
    const emergencyInfo = document.getElementById("emergency-info");
    const medicosList = document.getElementById("medicos-list");

    // Enviar mensagem para o chatbot Python/Gemini
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // Adicionar mensagem do usu√°rio ao chat
      addMessage("user", text);
      userInput.value = "";
      sendBtn.disabled = true;

      try {
        // Enviar para o backend Flask
        const response = await fetch("{{ url_for('home') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message: text })
        });

        const data = await response.json();

        if (data.success) {
          addMessage("ia", data.response);
          saveHistory(text);
        } else {
          addMessage("ia", `Erro: ${data.error}`);
        }
      } catch (error) {
        addMessage("ia", "Erro ao conectar com o servidor.");
        console.error(error);
      } finally {
        sendBtn.disabled = false;
        userInput.focus();
      }
    }

    function addMessage(sender, text) {
      const div = document.createElement("div");
      div.classList.add("message", sender);
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function saveHistory(message) {
      const li = document.createElement("li");
      li.textContent = message.substring(0, 50) + (message.length > 50 ? "..." : "");
      historyList.appendChild(li);
    }

    // Emerg√™ncia
    emergencyBtn.addEventListener("click", () => {
      emergencyInfo.textContent = "üìû Ligue imediatamente para o SAMU: 192";
      medicosList.innerHTML = "";
    });

    // M√©dicos pr√≥ximos
    findBtn.addEventListener("click", () => {
      emergencyInfo.textContent = "";
      const medicos = [
        { nome: "Dr. Jo√£o Silva", endereco: "Rua A, 123 - Centro", telefone: "(27) 99999-1111" },
        { nome: "Dra. Maria Santos", endereco: "Av. B, 456 - Jardim", telefone: "(27) 98888-2222" },
        { nome: "Dr. Carlos Pereira", endereco: "Rua C, 789 - Bairro Novo", telefone: "(27) 97777-3333" }
      ];

      medicosList.innerHTML = "";
      medicos.forEach(m => {
        const li = document.createElement("li");
        li.textContent = `${m.nome} - ${m.endereco} - ${m.telefone}`;
        medicosList.appendChild(li);
      });
    });

    function ajustarBarraChat() {
        const chatMessages = document.getElementById('chat');
        const chatBar = document.getElementById('chat-bar');

        if (chatMessages && chatBar) {
            const rect = chatMessages.getBoundingClientRect();
            chatBar.style.width = rect.width + "px";
            chatBar.style.left = rect.left + "px";
        }
    }

    window.addEventListener("resize", ajustarBarraChat);
    window.addEventListener("load", ajustarBarraChat);
  </script>
</body>

</html>